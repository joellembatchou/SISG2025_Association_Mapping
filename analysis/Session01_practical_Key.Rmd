---
title: "Practical 1 Key - Association Testing"
author: ""
date: ""
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---
Before you begin:

* Make sure that R is installed on your computer
* For this lab, we will use a few R libraries:
```{r load-libs}
library(data.table)
```

## Case-Control Association Testing

### Introduction
We will be using the [LHON dataset](https://raw.githubusercontent.com/joellembatchou/SISG2024_Association_Mapping/master/data/LHON.txt) covered in the lecture notes for this portion of the exercises.
The LHON dataset is from a case-control study and includes both phenotype and genotype data for a candidate gene.

Let's first load the LHON data file into the R session. We need to define the path to the file (if you have it downloaded on your machine, change the path to the file location).
```{r set-lhon-file}
LHON_FILE <- "https://raw.githubusercontent.com/joellembatchou/SISG2024_Association_Mapping/master/data/LHON.txt" 
```

We can now read the file
```{r load-lhon-data-direct, results = 'hide'}
LHON <- fread(LHON_FILE, header=TRUE)
```

### Helpful suggestions for R

There are many ways to obtain summary information for a dataset. Here are some short examples:

* Get information on number of rows/columns as well as the variables present in the data set
```{r}
str(LHON)
```
* Get counts for a specific variable in the table (use `$` to access a variable)
```{r}
table(LHON$GENO)
# cross tabulation for two variables
table(LHON$GENO, LHON$PHENO)
```
* Functions like `as.numeric()` and `factor()` will be useful to convert between numeric and categorical variables.
```{r}
LHON$GENO[1:5] # see the first 5 entries
as.numeric(factor(LHON$GENO, levels = c("CC", "CT", "TT")))[1:5] # convert to numeric specifying the order of the labels
```

* Note: For any R function you don't know the input syntax, you can get that information using `?<function_name>`, e.g. `?table` 


### Exercises
Here are some things to look at:

1. Examine the variables in the dataset
    * How many observations?  (use `str` function)
    * How many cases/controls?  (use `table` function)
    * What are the genotypes present in the variable `GENO`? (use `table` function)
        * To visualize the counts, you can use `barplot(table(LHON$GENO))`
    * What is the distribution of the genotypes across cases/controls? (use `table` function)
```{r}
barplot(table(LHON$GENO))

# Visualize the distribution of the genotypes across cases/controls
barplot(table(LHON$PHENO, LHON$GENO), col = c("blue","red"))
legend("topleft", legend = c("CASE", "CONTROL"), fill = c("blue","red"))

# Compute allele frequency for allele 'T'
(1 * sum(LHON$GENO == "CT") + 2 * sum(LHON$GENO == "TT")) / (2 * nrow(LHON))
```        

2. Perform a logistic regression analysis for this data with `CC` as the reference genotype using the `glm()` function. 

* First convert the `GENO` variable to a factor
```{r}
GENO_factor <- factor(LHON$GENO, levels = c("CC", "CT", "TT")) # convert to numeric specifying the order of the labels
```

* Convert the phenotype to a 0/1 variable
    
```{r}
pheno_binary <- 1 * (LHON$PHENO == "CASE")
```
* Check that the entries in `pheno_binary` with 1 correspond to `PHENO='CASE'`
```{r}
table(pheno_binary, LHON$PHENO)
```

* Run logistic regression using the `glm` function
```{r}
logistic_model_LHON <- glm(pheno_binary ~ GENO_factor, family = binomial(link = "logit"))
```  
You can get information about the model fit and parameter estimates (i.e. coefficients):
```{r}
summary(logistic_model_LHON)
```  

3. Obtain odds ratios and confidence intervals (CI) for the `CT` and `TT` genotypes relative to the `CC` reference genotype. Interpret.
    * use the lecture notes to obtain odds ratios & CI from estimates and standard errors.
```{r}
# Odds ratios for CT
exp(-1.5994)
# Odds ratios for TT
exp(-0.2654)
# Other way for all genotypes at once
exp(coef(logistic_model_LHON))


# CI for CT
exp( -1.5994 + c(-1,1) * 1.96 * 0.6378)
# CI for TT
exp( -0.2654 + c(-1,1) * 1.96 * 0.5349)
# Using R function `confint.default()`
exp(confint.default(logistic_model_LHON, level = 0.95))
```


4. Is there evidence of differences in odds of being a case for the `CT` and `TT` genotypes (compared to `CC`)?

Check the p-values.

#### *Extra*
5. Perform the logistic regression analysis with an additive genotype coding (e.g. counting the number of 'T' alleles). 
    * Hint: To convert to numerical, create a new variable with values 0/1/2 based on the genotypes (you can then use `table()` function to make sure the new variable was defined correctly).
```{r}
# create additive coding variable
GENO_additive_T <- 0 + 1 * (LHON$GENO == "CT") + 2 * (LHON$GENO == "TT")
# check it is correct by comparing with the original variable
table(GENO_additive_T, LHON$GENO)
# fit the logistic model
logistic_model_additive_LHON <- glm(pheno_binary ~ GENO_additive_T, family = binomial(link = "logit"))
summary(logistic_model_additive_LHON)
``` 

6. Obtain odds ratios and confidence intervals. Is there evidence of an association? How does it compare with the 2-parameter model?
```{r}
exp(coef(logistic_model_additive_LHON))
exp(confint.default(logistic_model_additive_LHON, level = 0.95))
``` 
  
## Association Testing with Quantitative Traits

### Introduction
We will be using the [Blood Pressure dataset](https://raw.githubusercontent.com/joellembatchou/SISG2024_Association_Mapping/master/data/bpdata.csv) for this portion of the exercises.
This dataset contains diastolic and systolic blood pressure measurements for 1000 individuals, and genotype data at 11 SNPs in a candidate gene for blood pressure. Covariates such as gender (sex) and body mass index (bmi) are included as well.

Let's first load the file into R. We need to define the path to the file (if you have it downloaded on your machine, change the path to the file location).
```{r set-bp-data, results = 'hide'}
BP_FILE <- "https://raw.githubusercontent.com/joellembatchou/SISG2024_Association_Mapping/master/data/bpdata.csv" 
```

Use the following command to read it into R:
```{r load-bp-data, results = 'hide'}
BP <- fread(BP_FILE, header=TRUE)
```

* Get a snippet of the data:
```{r}
head(BP, 2)
```

### Exercises
Here are some things to try:

1. Perform a linear regression of systolic blood pressure (`sbp`) on `SNP3` using the `lm()` function.
```{r}
linear_model_BP <- lm(sbp ~ snp3, data = BP)
```  
You can get information about the model fit and parameter estimates (i.e. coefficients):
```{r}
summary(linear_model_BP)
```  

2. Is there any evidence of an effect of the SNP on systolic blood pressure?

Check the p-values.

3. Provide a plot illustrating the relationship between sbp and the three genotypes at SNP3.
* How does it compare with the linear model fitted in question (1)?

```{r}
# show the mean in the boxplots (by default, only the median is shown)
with(BP, {
  # Draw the boxplots
  boxplot(sbp ~ snp3)
  # Calculate means
  means <- tapply(sbp, snp3, mean)
  # Add means to the boxplots
  points(x = 1:length(means), y = means, col = "red", pch = 18)
})
```


4. By default, the 2-parameter model is used since the SNP is stored in the data as categorical. Contrast the parameter estimates, p-values and confidence intervals obtained between this model and using:

    * additive (linear) model (counting the T allele)
    * dominant model 
    * recessive model

*Hint*: for each case, generate the appropriate allele coding variable and pass it to the `lm()` function. For example with additive coding:
```{r}
SNP3_additive <- 0 + 1 * (BP$snp3 == "TC") + 2 * (BP$snp3 == "TT")
linear_model_BP_additive <- lm(sbp ~ SNP3_additive, data = BP)
summary(linear_model_BP_additive)
```  
```{r}
SNP3_dominant <- 0 + 1 * (BP$snp3 == "TC") + 1 * (BP$snp3 == "TT")
linear_model_BP_dominant <- lm(sbp ~ SNP3_dominant, data = BP)
summary(linear_model_BP_dominant)
```  
```{r}
SNP3_recessive <- 0 + 0 * (BP$snp3 == "TC") + 1 * (BP$snp3 == "TT")
linear_model_BP_recessive <- lm(sbp ~ SNP3_recessive, data = BP)
summary(linear_model_BP_recessive)
```  


For question 5 and 6 below, R also has a 'formula' syntax, frequently used when specifying regression models with many predictors. To regress an outcome `y` on several covariates, the syntax is:

```{r lm-ex, eval=FALSE}
lm(y ~ covariate1 + covariate2 + covariate3)
```

5. Now redo the linear regression analysis of `sbp` from question 4 for the **additive model**, but this time adjust for `sex` and `bmi`. Do the results change?
```{r}
linear_model_BP_cov_adj <- lm(sbp ~ sex + bmi + SNP3_additive, data = BP)
summary(linear_model_BP_cov_adj)
```

#### *Extra*
6. What proportion of the variance of `sbp` is explained by all 11 SNPs combined using categorical coding?
* Use the `summary()` function to see the model results (the proportion of variance is the "Multiple R-squared" quantity)
```{r}
linear_model_BP_all_snps <- lm(sbp ~ snp1+snp2+snp3+snp4+snp5+snp6+snp7+snp8+snp9+snp10+snp11, data = BP)
summary(linear_model_BP_all_snps)
summary(linear_model_BP_all_snps)$r.sq
```

* How would it differ if an additive coding is used for the 11 SNPs? 
    * use `unique()` to check the genotypes for each SNP, e.g. `unique(BP$snp1)`
    * count the T allele (or A allele if applicable)
 
```{r}
unique(BP$snp1)
SNP1_additive <- 0 + 1 * (BP$snp1 == "CT") + 2 * (BP$snp1 == "TT")
unique(BP$snp2)
SNP2_additive <- 0 + 1 * (BP$snp2 == "AT") + 2 * (BP$snp2 == "TT")
unique(BP$snp3)
SNP3_additive <- 0 + 1 * (BP$snp3 == "TC") + 2 * (BP$snp3 == "TT")
unique(BP$snp4)
SNP4_additive <- 0 + 1 * (BP$snp4 == "CT") + 2 * (BP$snp4 == "TT")
unique(BP$snp5)
SNP5_additive <- 0 + 1 * (BP$snp5 == "CT") + 2 * (BP$snp5 == "TT")
unique(BP$snp6)
SNP6_additive <- 0 + 1 * (BP$snp6 == "AG") + 2 * (BP$snp6 == "AA")
unique(BP$snp7)
SNP7_additive <- 0 + 1 * (BP$snp7 == "AT") + 2 * (BP$snp7 == "AA")
unique(BP$snp8)
SNP8_additive <- 0 + 1 * (BP$snp8 == "CT") + 2 * (BP$snp8 == "TT")
unique(BP$snp9)
SNP9_additive <- 0 + 1 * (BP$snp9 == "CT") + 2 * (BP$snp9 == "TT")
unique(BP$snp10)
SNP10_additive <- 0 + 1 * (BP$snp10 == "CT") + 2 * (BP$snp10 == "TT")
unique(BP$snp11)
SNP11_additive <- 0 + 1 * (BP$snp11 == "CT") + 2 * (BP$snp11 == "TT")

linear_model_BP_all_snps_additive <- lm(sbp ~ SNP1_additive+SNP2_additive+SNP3_additive+SNP4_additive+SNP5_additive+SNP6_additive+SNP7_additive+SNP8_additive+SNP9_additive+SNP10_additive+SNP11_additive, data = BP)
summary(linear_model_BP_all_snps_additive)
summary(linear_model_BP_all_snps_additive)$r.sq
```
